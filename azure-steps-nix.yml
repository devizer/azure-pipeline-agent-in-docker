# AGENT_OS=Linux|Darwin|Windows_NT

steps:

  - bash: bash cross-platform/disable-ipv6.sh; sudo ifconfig -a || true
    displayName: 'Disable ipv6'
    
  - bash: |
      BUILD_URL="https://${ENDPOINT_URL_SYSTEMVSSCONNECTION}${SYSTEM_TEAMPROJECT}/_build/results?buildId=${BUILD_BUILDID}"
      echo "##vso[task.setvariable variable=BUILD_URL]$BUILD_URL"
      echo "BUILD_URL: [${BUILD_URL}]"
    displayName: 'VARS'
      
    
  - bash: |
      export XFW_VER=net47 NET_TEST_RUNNERS_INSTALL_DIR=/opt/net-test-runners; 
      export XFW_VER=net47 NET_TEST_RUNNERS_INSTALL_DIR=$(pwd)/cross-platform/bin/opt/net-test-runners;
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/lab/NET-TEST-RUNNERS-build.sh; 
      (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | sudo -E bash ||
      (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | sudo -E bash ||
      (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | sudo -E bash
      sudo apt-get install -yqq tree
      tree $NET_TEST_RUNNERS_INSTALL_DIR -h || true
      nunit3-console
    displayName: 'Build local test runners'
    
  - bash: |
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash;
      sudo apt-get update -qq; 
      sudo apt-get purge -qq man-db -y
      sudo apt-get install -y -qq qemu-user qemu-user-static
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/lab/Install-DOCKER.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash;
      # PART 2: EXPERIMENTAL
        echo '
        {
          "experimental": true
        }
        ' | sudo tee /etc/docker/daemon.json
      sudo systemctl restart docker
      mkdir -p ~/.docker
      echo '
        {
          "experimental": "enabled"
        }
        ' | tee ~/.docker/config.json
      docker version

      # register
      # docker run --rm --privileged docker/binfmt:820fdd95a9972a5308930a2bdfb8573dd4447ad3
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
      # docker buildx create --use --name mybuild || true - does not work?
      docker buildx create --name advancedx
      docker buildx use advancedx
      Say "Inspect"
      docker buildx inspect --bootstrap
      docker buildx inspect --bootstrap
      # list builders
      Say "Builder INFO"
      docker buildx ls

      Say "Docker INFO"
      docker version || true
    displayName: 'Configure Docker'

  - bash: |
        list-packages; list-packages || true
    displayName: 'List Packages'

  - bash: |
      Say "Builder INFO"
      docker buildx ls

      Say "Docker INFO"
      docker version || true
    displayName: 'Show Docker INFO'

  - bash: |
      set -e
      mkdir -p Log
      
      cd cross-platform
      agentname="test-agent-on-build"
      docker rm -f $agentname || true

      # set -o pipefail # !important
      time docker build --build-arg BASE_IMAGE=${BASE_IMAGE} -t devizervlad/crossplatform-azure-pipelines-agent:latest . #| tee Log/x64-build-image-log.log

      docker run -d --restart on-failure --privileged \
       --name $agentname \
       --hostname $agentname \
       -v /sys/fs/cgroup:/sys/fs/cgroup \
       -v /var/run/docker.sock:/var/run/docker.sock \
       devizervlad/crossplatform-azure-pipelines-agent:latest 

      docker exec -t $agentname bash -c '
       export VSTS_URL="https://devizer.visualstudio.com/";
       export VSTS_PAT='$MY_VSTS_PAT';
       export VSTS_POOL=temp-pool;
       export VSTS_AGENT='$agentname'; 
       export VSTS_WORK=work;
       /pre-configure/config-agent.sh' #| tee Log/x64-install-agent.log

      # if docker is not available?
      set +e
      docker exec -t $agentname bash -c "ls /var/run/docker.sock"
      docker exec -t $agentname bash -c "tree /var/run -h"
      docker exec -t $agentname bash -c "docker run -t --rm hello-world" | cat
      # DO NOT REMOVE LOCAL IMAGE for the VERSIONs Report step 
      true
      
    displayName: 'Build and test local x64 image'
    env:
      MY_VSTS_PAT: $(VSTS_PAT)

  - bash: |
      Say "/VERSION"
      docker exec -t test-agent-on-build cat /VERSION 
    displayName: 'VERSIONs Report'

  - bash: |
      df -T
      docker rm -f $(docker ps -aq)
      docker image rm $(docker image ls -a -q)
      docker image rm -f devizervlad/crossplatform-azure-pipelines-agent
      df -T
    displayName: 'free space'

  - bash: |
        set -e
        cd cross-platform || true 
        Say "Buildxing in $(pwd)"
        echo "   login: ${#MY_DOCKER_LOGIN} chars, value: '${MY_DOCKER_LOGIN}'"
        echo "password: ${#MY_DOCKER_PASSWORD} chars"
        docker login -u "$MY_DOCKER_LOGIN" -p "$MY_DOCKER_PASSWORD"
        if [[ "${BASE_IMAGE}" == "debian:jessie" ]]; then
          platform="linux/amd64,linux/arm/v7"
        else
          platform="linux/amd64,linux/arm64,linux/arm/v7"
        fi
        docker buildx build \
          --build-arg BASE_IMAGE=${BASE_IMAGE} \
          --platform $platform --push \
          ${TAGS} .
    displayName: 'x64+arm64+arm/v7: build and publish'
    env:
      MY_DOCKER_LOGIN: $(DOCKER_LOGIN)
      MY_DOCKER_PASSWORD: $(DOCKER_PASSWORD)

  - bash: |
        Show-System-Stat
        Say "The free space"
        df -T || true
        Say "Docker status"
        sudo systemctl status docker | cat || true
    condition: succeededOrFailed()
    displayName: 'Show-System-Stat'
        
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(Build.Repository.LocalPath)'
      artifactName: '$(Agent.JobName)-$(Build.BuildNumber)'
